<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
         "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta name="copyright" content="All content on muforth.nimblemachines.com is copyrighted. All rights are reserved." />
<meta name="keywords" content="2014, journal, blog" />
<meta name="robots" content="index,follow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="/-/screen.css" type="text/css" />
<link rel="canonical" href="http://muforth.nimblemachines.com/2014/" />
<title>2014 journal &ndash; muFORTH</title>
</head>
<body>

<div id="header">
<h1>2014 journal</h1>
<hr />
</div>

<div id="content">
<h3 id="april-12-13:20"><a href="#april-12-13:20">2014 April 12 13:20</a></h3>
<h4 id="another-forth-for-the-msp430"><a href="#another-forth-for-the-msp430">Another Forth for the MSP430?</a></h4>
<p>I&rsquo;ve had an interesting week. Between Friday, April 4, and Friday, April 11, I worked feverishly to add support for TI&rsquo;s MSP430 microcontroller to <a href="/">muFORTH</a>. The work is not quite done, but I&rsquo;m very pleased both with the results, and with how quickly it came together. During that time, I wrote:</p>
<ul>
<li>an assembler and a disassembler for MSP430 CPU instructions (but <em>not</em> for the CPUX extensions)</li>
<li>host-side support for the chip&rsquo;s bootstrap loader (BSL)</li>
<li>a small debug stub (which I call &ldquo;chat&rdquo;)</li>
<li>host-side support for chat (so I can read and write memory and registers, and execute code from <a href="/">muFORTH</a>)</li>
<li>support for writing to flash memory, both via the BSL and via chat</li>
<li>an initial Forth kernel for the MSP430</li>
</ul>
<p>What is currently missing is the rest of the kernel, and a working meta-compiler (sometimes called a cross- or target-compiler). Because the MSP430 instruction set is so well suited to Forth, building an indirect-threaded code (ITC) Forth is easy and efficient. NEXT is two instructions (two words) and four cycles. A call/return pair takes three words and eight cycles; so ITC is smaller, and faster by a factor of two!! Crazy.</p>
<p>ITC is elegant and beautiful, and is the perfect embodiment of Forth. I&rsquo;m excited that it will work well on this chip!</p>
<p>Meta-compiling an ITC Forth is almost trivial, unlike meta-compiling native code. Finishing the meta-compiler is maybe one more day of work.</p>
<p>The rest of the kernel could take some time, depending on what I decide I want to add. A small multitasker? Fancy math support? Those are both probably coming, but the timeframe is unknown.</p>
<h4 id="why-did-i-do-it"><a href="#why-did-i-do-it">Why did I do it?</a></h4>
<p>A friend was struggling to get his <a href="http://www.ti.com/tool/msp-exp430g2">Launchpad</a> to do much of anything. The debug story on the 430 Launchpad is pretty crazy. First, there is the <a href="http://www.ti.com/product/tusb3410">TUSB3410</a> &ndash; an 8052 clone with a USB interface. This chip implements a USB CDC-ACM interface, bridging between the host and the serial (UART) port of a second chip &ndash; an MSP430F1612, which does some JTAG/Spy-Bi-Wire heavy lifting to talk to the target chip (in our case, an <a href="http://www.ti.com/product/msp430g2553">MSP430G2553</a>). The protocol is, as far as I understand, undocumented, so we couldn&rsquo;t easily just target that from <a href="/">muFORTH</a>, which was my first thought.</p>
<p>Why not use the available tools? Well, they are Windows-only, for one. And they are also closed-source, limited (esp IAR Kickstart), and/or bloated (CodeComposer). We wanted to be able to talk to the chip from <a href="/">muFORTH</a>, on Linux and OSX.</p>
<p>After reading about the target chip, we decided to target the BSL &ndash; a ROM-based bit-banged-serial bootstrap loader that is built-in to almost every MSP430 chip. We tossed out the Launchpad (figuratively, if not literally), breadboarded a G2553, tickled it into the BSL using jumper wires, connected an <a href="http://www.dipmicro.com/store/PL2303HX-MOD">inexpensive USB-serial convertor</a>, and tried talking to it from <a href="/">muFORTH</a>. This took a few iterations &ndash; esp since, for all of this development, I have been writing code <em>with no access to hardware</em>!! To test, I push the code to my friend, he pulls and tries it out and tells me what happened. This would have been excruciatingly painful without audio chat, which we had going the entire time that we were debugging. Being able to talk hands-free while coding and brainstorming &ndash; to say nothing of fee-free! &ndash; was really liberating.</p>
<p>Once we could talk to the BSL, I wrote my chat stub, using my newly minted MSP430 assembler. Using the BSL, we copied this code to RAM and executed it, then switched some wires around &ndash; the BSL does <em>not</em> use the UART interface &ndash; we could talk via the chat protocol to the debug stub. Once I added a tiny piece of code to write a word to the flash memory, we could program the flash, and reboot into our own bootloader.</p>
<p>This all went suprprisingly well. At first we weren&rsquo;t getting anything out of chat &ndash; but then quickly realised that we had forgot to switch the wires around, and also to change the serial port settings. The BSL runs at 9600 bps, with even parity. My chat runs at 115,200 bps, with no parity. Once we remembered to switch the wires and the host-side serial port settings, everything worked.</p>
<p>But why write another MSP430 Forth?</p>
<p>This work differs from other efforts that I&rsquo;m aware of &ndash; such as <a href="http://www.camelforth.com/">CamelForth</a>, 4e4th <a href="http://www.4e4th.eu">(German site)</a> <a href="http://www.somersetweb.com/4E4th/EN.html">(English site)</a>, and <a href="http://mecrisp.sourceforge.net/">mecrisp</a> &ndash; by being a &ldquo;tethered&rdquo; Forth that compiles headless code &ndash; code without names &ndash; onto the target. This allows much bigger programs to fit into the flash. All the code to do the compiling and text processing is on the host, and leaving out the names saves a lot of space as well.</p>
<p>The <a href="http://www.ti.com/product/msp430g2553">MSP430G2553</a> &ndash; the chip that this work initially targets &ndash; has 16 KiB of flash. A <em>lot</em> of headless Forth code will fit into that space. ;-)</p>
<hr />
<p>Read the <a href="/2013/">2013 journal</a>.</p>

</div>

<div id="footer">
<hr />
<a href="mailto:%77%65%62%68%61%6d%73%74%65%72%40%6e%69%6d%62%6c%65%6d%61%63%68%69%6e%65%73%2e%63%6f%6d?subject=%5bmuFORTH%5d%202014%20journal">Send feedback</a> on this page (last edited 2016 November 12 14:13)<br />
Browse <a href="/all-pages/">all pages</a>, or return <a href="/">home</a>
</div>

</body>
</html>
